#!/bin/sh

set -eux

{% if operating_system.startswith('centos') %}
yum install -y mysql-connector-java

# Packages for network slowness debug purpose
yum install -y iftop iperf tcpdump

{% elif operating_system.startswith('ubuntu') or operating_system.startswith('debian') %}
apt-get install -y libmysql-java
{% endif %}

connector_jar=/usr/share/java/mysql-connector-java.jar
ambari_server_path=/var/lib/ambari-server
ambari_agent_path=/var/lib/ambari-agent

[ -d  ${ambari_server_path} ] && mkdir -p ${ambari_server_path}/jdbc-drivers && cp ${connector_jar} ${ambari_server_path}/jdbc-drivers
mkdir -p ${ambari_agent_path}/tmp/ && cp ${connector_jar} ${ambari_agent_path}/tmp/

if [ {{ ambari_username }} -ne "admin" ]; then
    useradd -m {{ ambari_username }}
    echo "y
    {{ ambari_username }}
    y
    n
    n" | ambari-server setup
    echo "Ambari user setup completed"

fi

for port_setting in RQUOTAD_PORT=875 LOCKD_TCPPORT=32803 LOCKD_UDPPORT=32769 MOUNTD_PORT=892 STATD_PORT=662
do
  echo $port_setting >> /etc/sysconfig/nfs
done

# Set http_proxy as workaround for the install failures
http_proxy_var=http://hwx-eng:5XD6xKQDiKDjOD@cache.eng.hortonworks.com:1280
proxy_host=http://cache.eng.hortonworks.com:1280
no_proxy_list='0.0.0.0,localhost,127.0.0.1,.openstacklocal,.novalocal,169.254.169.254,openstack.eng.hortonworks.com,dashboard.qe.hortonworks.com,172.22.192.250,192.175.27.100,ad-ec2.qe.hortonworks.com,ad-nano.qe.hortonworks.com,.site,.hwx.site,.hwx.site.com,172.27.0.101'

printf "\nexport http_proxy='${http_proxy_var}'\nexport https_proxy='${http_proxy_var}'" >> /etc/profile.d/hw-caching-proxy.sh
printf "\nexport no_proxy=${no_proxy_list}" >> /etc/profile.d/hw-caching-proxy.sh
printf "\nproxy=${proxy_host}\nproxy_username=${proxy_host}\nproxy_password=5XD6xKQDiKDjOD" >> /etc/yum.conf