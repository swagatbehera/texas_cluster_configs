#!/bin/sh

set -e

# Clone and setup log-collector
# TODO find a better way to handle keys
mkdir -p /root/.ssh

[ -f /root/.ssh/hortonworks-sustaining-id-rsa ] || cat > /root/.ssh/hortonworks-sustaining-id-rsa <<- EOM
-----BEGIN RSA PRIVATE KEY-----
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
-----END RSA PRIVATE KEY-----
EOM

[ -f /root/.ssh/hortonworks-sustaining-id-rsa-pub ] || cat > /root/.ssh/hortonworks-sustaining-id-rsa-pub <<- EOM
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQD3eodkr4b0kDnUZzDEpFsoAtIHdgwtomVPRsTMg5RRExjFrqD3qOWeBbqHpj3Yx7HtsSqS5Enxl7eRmeMiu2ac0daWOy9HJkN78On9nrFabDXc2kfRk3ww+8XiYfEe5eYzZXSeJlMoCc4OmCsHyTeqPXayp7GJcQ71jvpZBaS1ljZuu/utLa1JLqa3d+4GnI5tEmRm9RgX5/NhAQUTgpQr4oFxbh6c0Ks/SI6LHZsqpJaDLXKL5gefnK/HivYwBN0C807a8mCBDX4AQcOH+ADPbJRYR6mzopPTcnE0y6Cr3ElZAR13VZ1JjTzB6V73nKhELvEWaTow2gmNdbh1nAtZfCJ00WM0XpG8yIlHdT2EMwzL5G9LSz7Fu9QYZp1F9sJXoFuesBsyWOeY9xgpu5fg8Csa7JBJJ5f9jHnzkTb6FnzmYp0aMHZUqlfl1jmGK5P2PGK8et33JorJU3N0tm2WPfgLLGjCk1vp8B49SPw7GBvUFG6QnQU4wc5ErUIWnp1gaTWo6g+3cI6o73rDIv5A34ZijjpywuOS7rb/etCtKsCkc4MZqp77BsSNHcwmbcDMtrcrprVVTfU6XqYAN01SIZFQTr+IQ+xNWEl5Jajwm0KJ4xs37KJxAsNKlCGwJqiri8fNKC9peOlkPkzUwwOHvi8kevDJHQxjqgp+hmcPzw== hortonworks-sustaining@hortonworks.com
EOM

tee -a /root/.ssh/config > /dev/null << EOM
Host github.com
  IdentityFile /root/.ssh/hortonworks-sustaining-id-rsa
  StrictHostKeyChecking no
EOM

chmod -R 0400 /root/.ssh
chmod 0600 /root/.ssh/config

[ -d /root/infra-v2 ] || git clone -b qaas-log-collection git@github.com:hortonworks/infra-v2.git
cd /root/infra-v2

# Install pre-requisites for pyenv setup
{% if operating_system.startswith('ubuntu') or operating_system.startswith('debian') %}
apt-get install -y zlib1g-dev libssl-dev libsqlite3-dev libbz2-dev libreadline-dev
{% elif operating_system.startswith('centos') %}
yum install -y zlib-devel bzip2 bzip2-devel readline-devel sqlite sqlite-devel openssl-devel xz xz-devel gcc
{% endif %}


