#!/bin/sh

set -e

# Clone and setup log-collector
# TODO find a better way to handle keys
mkdir -p /root/.ssh

[ -f /root/.ssh/qe-group-id-rsa ] || cat > /root/.ssh/qe-group-id-rsa <<- EOM
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAvwGvUo7BMhyl9MaujG/KE6d4nlH+r1sHfI/t085U1EmX0ak0
C6auRmcQre/ogdas/nA0AZoQVH5+jc9Rfo6yKKgdzzA1PPcRFvIdQpZqAKinT7bb
kyZn1mWPTHYuog8zBOFinhcandyXDI/nBL3yRoVyC+qq+Ad2EpoVVi9lMXBcrLIn
UycUMxsr1dO6uI5BI1lk2acs8+31AJkWiraHIcDPT0DoX9TYqta/rSAAUCDR5z4e
j6u9F0EW27hB2bk/SCjbxHGQ0DZd0jZuSmH+HYumk9k2Ep2PhEP62SUsJ6cd1UIB
xQB1ioNRWp5a6h5m1HBZMU+iEGp603h7Jn+w2QIDAQABAoIBAAawUWprs1pE5I7g
0kX6uDHeAHxS1L9hSa7T/3kWVaQle5qM+VSbHqk6fLwKlbLOSLqURU31DjNXRqlC
pFDxQE3qLTkPMB4VbNTH37xwNgAV594Dwkax5pr8bXs4/EMSky/NkL2Gg5kZm3SG
KYnh+PT9QVQngJs0766RFMQy3rFPdYCevumWStZUPSUbGVGvMwbUkivfm3fDJmb7
5KNcQ0p86ZlJ3FOcoZAMI1vjk4F0n4zHt8OGzWgyoCJkon81wZ0qvCHuqyNyxo4X
Vd0t9z+B1VfDZDrHtQ/zz1+Ud4C3DxrH6cCAUwHwd0MRsUZsvnBltHuiOu1IpRaI
ZNy+VwECgYEA5DfJuhX4eaxpqVNlETHi/GkIIMf4eoTwrKHryiwOvHOzPqibTkzF
JmTIneQaf9NjUaQeoD3deDZgt6s/0Z4gZCK8mGOLm7v/jNCyjhaH8I8hxxi9ccf4
eHDKZrlsCUJmMhJobTtzTO1MBZfi7DQNGs8GHvnz95CEoz9+WUkLc/kCgYEA1kI8
63kPUrtyUkhmlVw5MDMq5MIsmGbjm8q7nlQRzNO7rhOwPeJR74x5gZnYK3wrChbP
Hnk67E9qbgXipK1YvHq3oq0377YwkcYSqScK+WzUMZ/WRhzq76BfcLhWS+yqITW9
vuD+4THa6aa9Lcch0jI9nz1p4ahv5UdKZuWvm+ECgYAobP1t2iB2pSTeWqhngFe9
8HkBHYsVYOElI1WaLW260h/pNIK2PwEZSPcEiPhstiw8tP670dmeRruhLVOTtRf1
xPV1ZQTA5G9jKUDHzJPt99y64NYGBq8r3obr5WKOzVU+/2XCG6rT8KDryLjosFu1
6QAjkpE1xELKjB+8fyTpOQKBgQDNtn0dLHd83IIv5Fmx8ADseUQmrRP6I1dHPkgT
BO6uNWBOC5M8Z255y+rhdx9o6Oe94RZtUMI1Hy61gisQJ2s6U6y6oQtCuS861u0V
wWm0/ztghfFKEfuzpMvdwu8AKLNT/XA3s3ikKKThjvi12ipr0Vb+7A0b3wfIIEGc
N8z6oQKBgQC02Zbyy2oOYYkX2iKQtLmVrqsTGSDkgaf7lOpdUm8Gt3PtG8kMbh17
3dkNOdlznukgZ7DLuTYDLlot+IMDoAnqRbTC8bCrjWE04JVQ80d95Ek+JYbWC73k
QQLDX7LBWSyI3V+g5fb7x4EvKoDuBhGwpYVe5jBjDYCUjMDMecMiBg==
-----END RSA PRIVATE KEY-----
EOM

[ -f /root/.ssh/qe-group-id-rsa-pub ] || cat > /root/.ssh/qe-group-id-rsa-pub <<- EOM
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/Aa9SjsEyHKX0xq6Mb8oTp3ieUf6vWwd8j+3TzlTUSZfRqTQLpq5GZxCt7+iB1qz+cDQBmhBUfn6Nz1F+jrIoqB3PMDU89xEW8h1ClmoAqKdPttuTJmfWZY9Mdi6iDzME4WKeFxqd3JcMj+cEvfJGhXIL6qr4B3YSmhVWL2UxcFyssidTJxQzGyvV07q4jkEjWWTZpyzz7fUAmRaKtochwM9PQOhf1Niq1r+tIABQINHnPh6Pq70XQRbbuEHZuT9IKNvEcZDQNl3SNm5KYf4di6aT2TYSnY+EQ/rZJSwnpx3VQgHFAHWKg1FanlrqHmbUcFkxT6IQanrTeHsmf7DZ qe-group@hortonworks.com
EOM

tee -a /root/.ssh/config > /dev/null << EOM
Host github.com
  IdentityFile /root/.ssh/qe-group-id-rsa
  StrictHostKeyChecking no
EOM

chmod -R 0400 /root/.ssh
chmod 0600 /root/.ssh/config



[ -d /root/ansible-hdf ] || git clone -b master git@github.com:hortonworks/ansible-hdf.git

# Install pre-requisites



# making sure to get the latest Ansible

{% if cloudbreak.operating_system.startswith('ubuntu') %}
apt-get update && apt-get install software-properties-common -y && apt-add-repository ppa:ansible/ansible -y -u
{% endif %}


{% if cloudbreak.operating_system.startswith('debian') %}
   echo "deb http://ppa.launchpad.net/ansible/ansible/ubuntu trusty main" >> /etc/apt/sources.list
   apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 93C4A3FD7BB9C367
   apt-get update
{% endif %}



{% if cloudbreak.operating_system.startswith('ubuntu') or cloudbreak.operating_system.startswith('debian') %}


apt-get install -y python-ldap zlib1g-dev libssl-dev libsqlite3-dev libbz2-dev libreadline-dev ansible

{% elif cloudbreak.operating_system.startswith('centos') %}

yum install -y python-ldap zlib-devel bzip2 bzip2-devel readline-devel sqlite sqlite-devel openssl-devel xz xz-devel gcc make automake libffi-devel ansible
{% elif cloudbreak.operating_system.startswith('sles') %}

echo "solver.allowVendorChange = true" >> /etc/zypp/zypp.conf
zypper --non-interactive --quiet addrepo --refresh http://download.opensuse.org/repositories/home:/loosi:/ldap/openSUSE_Leap_42.3/home:loosi:ldap.repo
zypper --non-interactive --quiet addrepo --refresh http://download.opensuse.org/update/leap/42.3/oss//openSUSE:Leap:42.3:Update.repo
zypper --non-interactive --quiet addrepo --refresh https://download.opensuse.org/repositories/home:/frispete:/python/openSUSE_Tumbleweed/home:frispete:python.repo
zypper --non-interactive --quiet addrepo --refresh https://download.opensuse.org/repositories/security:/SELinux/openSUSE_Leap_42.3/security:SELinux.repo
zypper --non-interactive --quiet addrepo --refresh https://download.opensuse.org/repositories/home:/odassau/SLE_12_SP3/home:odassau.repo
zypper --gpg-auto-import-keys --non-interactive refresh

# python-xml is needed for zypper ansible module
zypper -n install python-xml python-ldap
pip install ansible

{% endif %}

playbook_dir=/root/ansible-hdf/install-openldap

# Overwrite the ansible.cfg
cat > ${playbook_dir}/ansible.cfg << EOF

[defaults]
hostfile = hosts

EOF

# Overwrite the hosts file
cat > ${playbook_dir}/hosts << EOF

[local]
localhost ansible_connection=local

EOF


# Invoke playbook
ansible-playbook ${playbook_dir}/open-ldap.yml -e "hosts_variable=localhost"